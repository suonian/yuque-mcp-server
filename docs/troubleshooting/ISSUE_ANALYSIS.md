# 🔍 问题分析：文档ID获取失败

## 问题描述

用户通过搜索找到文档（ID: 228724004），但使用 `mcp__get_doc_by_id` 接口获取文档内容时失败。

---

## 🔎 根本原因分析

### 1. **语雀API限制**

**关键发现**：语雀API **不支持**直接通过文档ID获取文档内容。

语雀API的文档获取接口：
- ✅ 支持：`GET /repos/{namespace}/docs/{slug}` （需要 namespace + slug）
- ❌ 不支持：`GET /docs/{doc_id}` （直接通过文档ID）

### 2. **当前代码实现**

检查代码后发现：
- ❌ **没有** `get_doc_by_id` 工具
- ✅ 只有 `get_doc(namespace, slug)` 工具
- ✅ 搜索返回结果中**已包含** `namespace` 和 `slug` 信息

### 3. **用户使用方式问题**

用户尝试使用不存在的接口：
```
mcp__get_doc_by_id (doc_id=228724004)  ❌ 接口不存在
```

应该使用：
```
get_doc (namespace="xxx/xxx", slug="xxx")  ✅ 正确方式
```

---

## 💡 解决方案

### 方案 1：实现 `get_doc_by_id` 工具（推荐）

**实现思路**：
1. 通过文档ID，先搜索找到文档的 namespace 和 slug
2. 然后使用 `get_doc(namespace, slug)` 获取完整内容

**优点**：
- 用户体验更好，可以直接使用文档ID
- 符合用户的使用习惯

**缺点**：
- 需要两次API调用（搜索 + 获取）
- 如果文档不在搜索结果中，可能找不到

### 方案 2：改进搜索结果展示（快速修复）

**实现思路**：
1. 在搜索结果中更突出地显示 namespace 和 slug
2. 提供"一键获取"的提示信息
3. 明确告知用户如何使用返回的信息

**优点**：
- 无需修改API
- 快速实现

**缺点**：
- 用户仍需要手动提取 namespace 和 slug

### 方案 3：智能文档获取（最佳体验）

**实现思路**：
1. 实现 `get_doc_by_id` 工具
2. 支持多种方式获取：
   - 优先：如果搜索结果中有缓存，直接使用
   - 备选：通过搜索API查找文档
   - 最后：尝试通过文档ID直接访问（如果API支持）

**优点**：
- 用户体验最佳
- 自动处理各种情况

**缺点**：
- 实现复杂度较高

---

## 🚀 推荐实施方案

### 阶段 1：快速修复（立即实施）

1. **改进搜索结果展示**
   - 更清晰地显示 namespace 和 slug
   - 添加使用示例

2. **添加工具说明**
   - 在 `get_doc` 工具描述中说明如何使用搜索结果

### 阶段 2：功能增强（1-2天）

1. **实现 `get_doc_by_id` 工具**
   - 通过搜索API查找文档
   - 自动提取 namespace 和 slug
   - 调用 `get_doc` 获取完整内容

2. **添加错误处理**
   - 文档不存在时的友好提示
   - 权限不足时的明确说明

### 阶段 3：优化体验（可选）

1. **实现缓存机制**
   - 缓存搜索结果
   - 减少重复API调用

2. **智能重试**
   - 多种方式尝试获取文档
   - 自动降级策略

---

## 📝 具体实现代码

### 实现 `get_doc_by_id` 工具

```python
def get_doc_by_id(self, doc_id: int) -> Dict[str, Any]:
    """通过文档ID获取文档内容
    
    注意：语雀API不支持直接通过文档ID获取文档，
    此方法会先通过搜索找到文档的namespace和slug，
    然后获取完整内容。
    """
    # 1. 尝试通过搜索找到文档
    # 注意：搜索API可能无法精确匹配文档ID，需要其他方式
    
    # 2. 如果搜索失败，返回错误提示
    # 建议用户使用 get_doc(namespace, slug) 方式
    
    pass
```

**更好的实现方式**：
由于语雀搜索API无法通过文档ID精确搜索，建议：
1. 在搜索结果中缓存文档信息（namespace + slug + doc_id）
2. 实现一个映射表或缓存机制
3. 或者，要求用户从搜索结果中提取信息

---

## 🎯 立即行动项

### 优先级 1：改进用户体验（立即）

1. ✅ **增强搜索结果展示**
   ```python
   # 在 format_search_results 中
   result.append(f"   📋 使用方法: get_doc(namespace=\"{namespace}\", slug=\"{slug}\")")
   ```

2. ✅ **添加工具说明文档**
   - 更新 `get_doc` 工具描述
   - 说明如何从搜索结果中提取参数

### 优先级 2：实现新功能（1-2天）

1. **实现 `get_doc_by_id` 工具**
   - 通过搜索查找文档（如果可能）
   - 提供友好的错误提示
   - 引导用户使用正确的方式

2. **增强错误处理**
   - 文档不存在时的明确提示
   - 提供替代方案

---

## 📊 问题影响评估

| 影响范围 | 严重程度 | 优先级 |
|---------|---------|--------|
| 用户体验 | 🔴 高 | P0 |
| 功能完整性 | 🟡 中 | P1 |
| 开发工作量 | 🟢 低 | - |

---

## ✅ 验收标准

- [ ] 用户可以通过文档ID获取文档内容（或得到明确的错误提示）
- [ ] 搜索结果中清晰显示如何使用返回的信息
- [ ] 错误提示友好，包含解决建议
- [ ] 文档已更新，说明正确的使用方法

---

## 📚 参考资源

- [语雀API文档](https://www.yuque.com/yuque/developer/api)
- [MCP协议规范](https://modelcontextprotocol.io/)

---

**问题状态**: 🔴 待解决  
**预计完成时间**: 1-2天  
**负责人**: 开发团队

